#!/bin/bash

echo "ğŸ” Markdown ë° MDX íŒŒì¼ì—ì„œ URL ê²€ì‚¬ ì‹œì‘..."

# URL ìœ„ì¹˜ ì •ë³´ë¥¼ ì €ì¥í•  associative array
declare -A urlLocations

# 1. Markdown ë° MDX íŒŒì¼ì—ì„œ URL ì¶”ì¶œ
echo "ğŸ”— íŒŒì¼ì—ì„œ URL ì¶”ì¶œ ì¤‘..."
find . -type f \( -iname "*.md" -o -iname "*.mdx" \) -exec awk '
{
    remainder = $0;
    while (match(remainder, /\[[^]]+\]\((https?:\/\/[^)]+)\)/, arr)) {
        print FILENAME ":" FNR ":" arr[1]; # íŒŒì¼ëª…, ë¼ì¸ ë²ˆí˜¸, URL ì¶œë ¥
        remainder = substr(remainder, RSTART + RLENGTH);
    }
}
' {} + > extracted_links.txt

# URLê³¼ ìœ„ì¹˜ ì •ë³´ë¥¼ ë¶„ë¦¬
echo "ğŸ”— ì¶”ì¶œëœ URL ì •ë¦¬ ì¤‘..."
while IFS=: read -r file line url; do
    if [[ -n "$url" ]]; then
        if [[ -n "${urlLocations[$url]}" ]]; then
            urlLocations["$url"]+=", ${file}:${line}"
        else
            urlLocations["$url"]="${file}:${line}"
        fi
    fi
done < extracted_links.txt

# URL ë¦¬ìŠ¤íŠ¸ ìƒì„±
echo "ğŸ”— ì¤‘ë³µ ì œê±°ëœ URL ì €ì¥..."
echo "${!urlLocations[@]}" | tr ' ' '\n' > url_list.txt

# 2. URL ê²€ì‚¬
echo "ğŸš€ URL ìƒíƒœ ê²€ì‚¬ ì¤‘..."
declare -A errorInfo

# ë³‘ë ¬ë¡œ curlì„ ì‹¤í–‰í•˜ì—¬ ìƒíƒœ ì½”ë“œ í™•ì¸ (HTTP 429ëŠ” ë¬´ì‹œ)
cat url_list.txt | xargs -P 10 -I {} bash -c '
    status=$(curl -o /dev/null -s -w "%{http_code}" "{}")
    if [[ "$status" -ge 400 && "$status" -ne 429 ]]; then
        echo "âŒ {} (ìƒíƒœ ì½”ë“œ: $status)"
        echo "{} $status" >> invalid_urls_tmp.txt
    elif [[ "$status" -lt 400 ]]; then
        echo "âœ… {}"
    fi
'

# 3. ì˜¤ë¥˜ URL ì •ë¦¬
if [[ -f invalid_urls_tmp.txt ]]; then
    while IFS=' ' read -r url status; do
        errorInfo["$url"]="ìƒíƒœ ì½”ë“œ: $status | ìœ„ì¹˜: ${urlLocations[$url]}"
    done < invalid_urls_tmp.txt
    rm invalid_urls_tmp.txt
fi

# 4. ê²°ê³¼ ì¶œë ¥
echo
if [ ${#errorInfo[@]} -gt 0 ]; then
    echo "â€¼ï¸ ìœ íš¨í•˜ì§€ ì•Šì€ URL ëª©ë¡:"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    for url in "${!errorInfo[@]}"; do
        echo "ğŸ”— $url"
        echo "   â””â”€ ${errorInfo[$url]}"
    done
else
    echo "ëª¨ë“  ë§í¬ê°€ ì •ìƒì…ë‹ˆë‹¤!"
fi

# ì„ì‹œ íŒŒì¼ ì‚­ì œ
rm extracted_links.txt url_list.txt
