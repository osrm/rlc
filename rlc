#!/bin/bash

echo "🔍 Markdown 및 MDX 링크 검사 중..."

# URL의 위치 정보(파일명:라인번호)를 저장할 associative array (Bash 4 이상 필요)
declare -A urlLocations

# find 명령어로 현재 및 하위 디렉터리의 .md, .mdx 파일들을 찾고,
# awk를 사용하여 각 파일에서 Markdown 링크 형식([텍스트](URL))의 URL을 추출함.
while IFS=: read -r file line url; do
    # URL이 비어있으면 스킵
    if [[ -z "$url" ]]; then
        continue
    fi
    if [[ -n "${urlLocations[$url]}" ]]; then
        urlLocations["$url"]+=", ${file}:${line}"
    else
        urlLocations["$url"]="${file}:${line}"
    fi
done < <(
    find . -type f \( -iname "*.md" -o -iname "*.mdx" \) -exec awk '
    {
        remainder = $0;
        while(match(remainder, /\[[^]]+\]\((https?:\/\/[^)]+)\)/, arr)) {
            print FILENAME ":" FNR ":" arr[1];
            remainder = substr(remainder, RSTART + RLENGTH);
        }
    }
    ' {} +
)

# 검사 대상 링크 수 출력
count=${#urlLocations[@]}
echo "🔗 검사 대상 링크 수: $count"
echo

# URL 검사: 각 URL에 대해 curl로 HTTP 상태코드를 받아 검사
declare -A errorInfo
for url in "${!urlLocations[@]}"; do
    status=$(curl -o /dev/null -s -w "%{http_code}" "$url")
    if [[ "$status" -ge 200 && "$status" -lt 400 ]]; then
        echo "✅ $url"
    else
        echo "❌ $url (Status: $status)"
        errorInfo["$url"]="$status | 위치: ${urlLocations[$url]}"
    fi
done

# 오류가 발생한 링크 목록 최종 출력
if [ ${#errorInfo[@]} -gt 0 ]; then
    echo
    echo "‼️ 오류가 발생한 링크 목록:"
    for url in "${!errorInfo[@]}"; do
        echo "- $url → ${errorInfo[$url]}"
    done
else
    echo
    echo "모든 링크가 정상입니다!"
fi
