#!/bin/bash

echo "ğŸ” Markdown ë° MDX ë§í¬ ê²€ì‚¬ ì¤‘..."

# URLì˜ ìœ„ì¹˜ ì •ë³´(íŒŒì¼ëª…:ë¼ì¸ë²ˆí˜¸)ë¥¼ ì €ì¥í•  associative array (Bash 4 ì´ìƒ í•„ìš”)
declare -A urlLocations

# find ëª…ë ¹ì–´ë¡œ í˜„ì¬ ë° í•˜ìœ„ ë””ë ‰í„°ë¦¬ì˜ .md, .mdx íŒŒì¼ë“¤ì„ ì°¾ê³ ,
# awkë¥¼ ì‚¬ìš©í•˜ì—¬ ê° íŒŒì¼ì—ì„œ Markdown ë§í¬ í˜•ì‹([í…ìŠ¤íŠ¸](URL))ì˜ URLì„ ì¶”ì¶œí•¨.
# í•œ ì¤„ì— ì—¬ëŸ¬ ë§í¬ê°€ í¬í•¨ëœ ê²½ìš°ë„ ëª¨ë‘ ì¶”ì¶œí•˜ë„ë¡ ë°˜ë³µí•¨.
file_count=0
total_files=$(find . -type f \( -iname "*.md" -o -iname "*.mdx" \) | wc -l)

# íŒŒì¼ì„ í•˜ë‚˜ì”© í™•ì¸í•˜ë©´ì„œ URLì„ ì¶”ì¶œ
while IFS=: read -r file line url; do
    # URLì´ ë¹„ì–´ìˆìœ¼ë©´ ìŠ¤í‚µ
    if [[ -z "$url" ]]; then
        continue
    fi
    if [[ -n "${urlLocations[$url]}" ]]; then
        urlLocations["$url"]+=", ${file}:${line}"
    else
        urlLocations["$url"]="${file}:${line}"
    fi

    # ì§„í–‰ë¥  ì¶œë ¥
    file_count=$((file_count + 1))
    echo -ne "ğŸ”— ê²€ì‚¬ ì¤‘... $file_count/$total_files íŒŒì¼ ê²€ì‚¬ ì¤‘\r"
done < <(
    find . -type f \( -iname "*.md" -o -iname "*.mdx" \) -exec awk '
    {
        remainder = $0;
        while(match(remainder, /\[[^]]+\]\((https?:\/\/[^)]+)\)/, arr)) {
            print FILENAME ":" FNR ":" arr[1];
            remainder = substr(remainder, RSTART + RLENGTH);
        }
    }
    ' {} +
)

echo -e "\nğŸ”— ê²€ì‚¬ ëŒ€ìƒ ë§í¬ ìˆ˜: ${#urlLocations[@]}"
echo

# URL ê²€ì‚¬: ê° URLì— ëŒ€í•´ curlë¡œ HTTP ìƒíƒœì½”ë“œë¥¼ ë°›ì•„ ê²€ì‚¬
declare -A errorInfo
for url in "${!urlLocations[@]}"; do
    status=$(curl -o /dev/null -s -w "%{http_code}" "$url")
    if [[ "$status" -ge 200 && "$status" -lt 400 ]]; then
        echo "âœ… $url"
    elif [[ "$status" -ne 000 ]]; then  # ìƒíƒœ ì½”ë“œê°€ 000ì´ ì•„ë‹ˆë©´ ì˜¤ë¥˜ë¡œ ì²˜ë¦¬
        echo "âŒ $url (ìƒíƒœ ì½”ë“œ: $status)"
        errorInfo["$url"]="$status | ìœ„ì¹˜: ${urlLocations[$url]}"
    fi
done

# ì˜¤ë¥˜ê°€ ë°œìƒí•œ ë§í¬ ëª©ë¡ ìµœì¢… ì¶œë ¥
if [ ${#errorInfo[@]} -gt 0 ]; then
    echo
    echo "â€¼ï¸ ì˜¤ë¥˜ê°€ ë°œìƒí•œ ë§í¬ ëª©ë¡:"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    for url in "${!errorInfo[@]}"; do
        echo "ğŸ”— $url"
        echo "   â””â”€ ìƒíƒœ ì½”ë“œ: ${errorInfo[$url]}"
    done
else
    echo
    echo "ëª¨ë“  ë§í¬ê°€ ì •ìƒì…ë‹ˆë‹¤!"
fi
