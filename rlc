#!/bin/bash

echo "ğŸ” Markdown ë° MDX ë§í¬ ê²€ì‚¬ ì¤‘..."

# URLì˜ ìœ„ì¹˜ ì •ë³´(íŒŒì¼ëª…:ë¼ì¸ë²ˆí˜¸)ë¥¼ ì €ì¥í•  associative array (Bash 4 ì´ìƒ í•„ìš”)
declare -A urlLocations

# find ëª…ë ¹ì–´ë¡œ í˜„ì¬ ë° í•˜ìœ„ ë””ë ‰í„°ë¦¬ì˜ .md, .mdx íŒŒì¼ë“¤ì„ ì°¾ê³ ,
# awkë¥¼ ì‚¬ìš©í•˜ì—¬ ê° íŒŒì¼ì—ì„œ Markdown ë§í¬ í˜•ì‹([í…ìŠ¤íŠ¸](URL))ì˜ URLì„ ì¶”ì¶œí•¨.
while IFS=: read -r file line url; do
    # URLì´ ë¹„ì–´ìˆìœ¼ë©´ ìŠ¤í‚µ
    if [[ -z "$url" ]]; then
        continue
    fi
    if [[ -n "${urlLocations[$url]}" ]]; then
        urlLocations["$url"]+=", ${file}:${line}"
    else
        urlLocations["$url"]="${file}:${line}"
    fi
done < <(
    find . -type f \( -iname "*.md" -o -iname "*.mdx" \) -exec awk '
    {
        remainder = $0;
        while(match(remainder, /\[[^]]+\]\((https?:\/\/[^)]+)\)/, arr)) {
            print FILENAME ":" FNR ":" arr[1];
            remainder = substr(remainder, RSTART + RLENGTH);
        }
    }
    ' {} +
)

# ê²€ì‚¬ ëŒ€ìƒ ë§í¬ ìˆ˜ ì¶œë ¥
count=${#urlLocations[@]}
echo "ğŸ”— ê²€ì‚¬ ëŒ€ìƒ ë§í¬ ìˆ˜: $count"
echo

# URL ê²€ì‚¬: ê° URLì— ëŒ€í•´ curlë¡œ HTTP ìƒíƒœì½”ë“œë¥¼ ë°›ì•„ ê²€ì‚¬
declare -A errorInfo
for url in "${!urlLocations[@]}"; do
    status=$(curl -o /dev/null -s -w "%{http_code}" "$url")
    if [[ "$status" -ge 200 && "$status" -lt 400 ]]; then
        echo "âœ… $url"
    else
        echo "âŒ $url (Status: $status)"
        errorInfo["$url"]="$status | ìœ„ì¹˜: ${urlLocations[$url]}"
    fi
done

# ì˜¤ë¥˜ê°€ ë°œìƒí•œ ë§í¬ ëª©ë¡ ìµœì¢… ì¶œë ¥
if [ ${#errorInfo[@]} -gt 0 ]; then
    echo
    echo "â€¼ï¸ ì˜¤ë¥˜ê°€ ë°œìƒí•œ ë§í¬ ëª©ë¡:"
    for url in "${!errorInfo[@]}"; do
        echo "- $url â†’ ${errorInfo[$url]}"
    done
else
    echo
    echo "ëª¨ë“  ë§í¬ê°€ ì •ìƒì…ë‹ˆë‹¤!"
fi
