#!/bin/bash


echo "🔍 Markdown 링크 검사 중..."

# Markdown 파일을 재귀적으로 검색하여 [text](url) 패턴의 http/https 링크만 추출
grep -rPo '\[.*?\]\(\Khttps?://[^\)]+' --include="*.md","*.mdx" . > /tmp/all_links.txt

# 중복 제거
sort -u /tmp/all_links.txt > /tmp/unique_links.txt


# 각 파일마다 링크 검사
while IFS= read -r file; do
    while IFS= read -r url; do
        # 해당 파일에 포함된 링크인지 확인
        if grep -q "$url" "$file"; then
            status=$(curl -o /dev/null -s -w "%{http_code}" "$url")
            if [[ "$status" -ge 400 || "$status" -eq 000 ]]; then
                echo "❌ $file → $url (Status: $status)"
            fi
        fi
    done < /tmp/unique_links.txt
done < <(find . -type f -name "*.md")

# 임시파일 삭제
rm /tmp/all_links.txt /tmp/unique_links.txt
