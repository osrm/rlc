#!/bin/bash

echo "ğŸ” Markdown ë° MDX ë§í¬ ê²€ì‚¬ ì¤‘..."

# ê° URLì— ëŒ€í•´, "íŒŒì¼:ë¼ì¸" ìœ„ì¹˜ë“¤ì„ ì €ì¥í•  associative array ì„ ì–¸ (Bash 4 ì´ìƒ í•„ìš”)
declare -A urlLocations

# .md ë° .mdx íŒŒì¼ ëª¨ë‘ì—ì„œ URLì„ ì¶”ì¶œí•˜ì—¬, íŒŒì¼ëª…:ë¼ì¸ë²ˆí˜¸:URL í˜•ì‹ìœ¼ë¡œ ì½ì–´ë“¤ì„
while IFS=: read -r file line url; do
    # ë§Œì•½ URLì— ì´ë¯¸ ìœ„ì¹˜ ì •ë³´ê°€ ìˆë‹¤ë©´ ì½¤ë§ˆë¡œ êµ¬ë¶„í•˜ì—¬ ì¶”ê°€
    if [[ -n "${urlLocations[$url]}" ]]; then
        urlLocations[$url]+=", ${file}:${line}"
    else
        urlLocations[$url]="${file}:${line}"
    fi
done < <(find . -type f \( -iname "*.md" -o -iname "*.mdx" \) -exec grep -Pno '

\[.*?\]

\(\Khttps?://[^\)]+' {} \;)

count=${#urlLocations[@]}
echo "ğŸ”— ê²€ì‚¬ ëŒ€ìƒ ë§í¬ ìˆ˜: $count"
echo

# ì˜¤ë¥˜ê°€ ë°œìƒí•œ ë§í¬ì˜ ì •ë³´ë¥¼ ì €ì¥í•˜ê¸° ìœ„í•œ associative array
declare -A errorInfo

# ê° ê³ ìœ  ë§í¬ì— ëŒ€í•´ curlë¡œ HTTP ìƒíƒœ ì½”ë“œ ê²€ì‚¬
for url in "${!urlLocations[@]}"; do
    status=$(curl -o /dev/null -s -w "%{http_code}" "$url")
    if [[ "$status" -ge 200 && "$status" -lt 400 ]]; then
        echo "âœ… $url"
    else
        echo "âŒ $url (Status: $status)"
        errorInfo["$url"]="$status | ìœ„ì¹˜: ${urlLocations[$url]}"
    fi
done

# ê²€ì‚¬ í›„, ì˜¤ë¥˜ê°€ ë°œìƒí•œ ë§í¬ì™€ ìœ„ì¹˜ë“¤ì„ ëª©ë¡ìœ¼ë¡œ ì¶œë ¥
if [ ${#errorInfo[@]} -gt 0 ]; then
    echo
    echo "â€¼ï¸ ì˜¤ë¥˜ê°€ ë°œìƒí•œ ë§í¬ ëª©ë¡:"
    for url in "${!errorInfo[@]}"; do
        echo "- $url â†’ ${errorInfo[$url]}"
    done
else
    echo
    echo "ëª¨ë“  ë§í¬ê°€ ì •ìƒì…ë‹ˆë‹¤!"
fi
