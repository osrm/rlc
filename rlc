#!/bin/bash

echo "ğŸ” Markdown ë° MDX ë§í¬ ê²€ì‚¬ ì¤‘..."

declare -A urlLocations

# ë§í¬ ì¶”ì¶œ
while IFS=: read -r file line url; do
    [[ -z "$url" ]] && continue
    if [[ -n "${urlLocations[$url]}" ]]; then
        urlLocations["$url"]+=", ${file}:${line}"
    else
        urlLocations["$url"]="${file}:${line}"
    fi
done < <(
    find . -type f \( -iname "*.md" -o -iname "*.mdx" \) -exec awk '
    {
        remainder = $0;
        while(match(remainder, /\[[^]]+\]\((https?:\/\/[^)]+)\)/, arr)) {
            print FILENAME ":" FNR ":" arr[1];
            remainder = substr(remainder, RSTART + RLENGTH);
        }
    }
    ' {} +
)

total=${#urlLocations[@]}
echo "ğŸ”— ê²€ì‚¬ ëŒ€ìƒ ë§í¬ ìˆ˜: $total"
echo

# ì„ì‹œ íŒŒì¼
tmp_output=$(mktemp)
> "$tmp_output"

# ì§„í–‰ ìƒíƒœë¥¼ ìœ„í•œ ì„ì‹œ ì¹´ìš´í„° íŒŒì¼
counter_file=$(mktemp)
echo 0 > "$counter_file"

# ë³‘ë ¬ í•¨ìˆ˜ ì •ì˜
check_url() {
    local url="$1"
    local location="$2"
    local index_file="$3"
    local total="$4"

    local status
    status=$(curl -o /dev/null -s -w "%{http_code}" "$url")

    # ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
    {
        flock -x 200
        current=$(< "$index_file")
        current=$((current + 1))
        echo "$current" > "$index_file"
        echo "ğŸ”„ [$current/$total] ê²€ì‚¬ ì¤‘: $url"
    } 200<>"$index_file"

    # ê²°ê³¼ ê¸°ë¡
    if [[ "$status" -ge 200 && "$status" -lt 400 ]]; then
        echo "âœ… $url" >> "$tmp_output"
    elif [[ "$status" == "429" ]]; then
        echo "âš ï¸  $url | 429 Too Many Requests (ë¬´ì‹œë¨)" >> "$tmp_output"
    else
        echo "âŒ $url | $status | ìœ„ì¹˜: $location" >> "$tmp_output"
    fi
}

export -f check_url
export tmp_output
export counter_file

# ì…ë ¥ ì¤€ë¹„: URL | ìœ„ì¹˜
printf "%s|%s\n" "${!urlLocations[@]}" "${urlLocations[@]}" | \
    paste -d "|" - - | \
    xargs -P3 -n1 -I{} bash -c '
        IFS="|" read -r url location <<< "{}"
        check_url "$url" "$location" "$counter_file" '"$total"'
    '

echo
echo "ğŸ“„ ê²€ì‚¬ ê²°ê³¼:"
grep -E "^âœ…|^âš ï¸" "$tmp_output" | sort
echo

# ì˜¤ë¥˜ ì¶œë ¥ ì •ë¦¬
errors=$(grep "^âŒ" "$tmp_output")
if [[ -n "$errors" ]]; then
    echo "â€¼ï¸ ì˜¤ë¥˜ê°€ ë°œìƒí•œ ë§í¬ ëª©ë¡:"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    while IFS= read -r line; do
        url=$(echo "$line" | cut -d '|' -f1 | sed 's/^âŒ //')
        status=$(echo "$line" | cut -d '|' -f2 | xargs)
        location=$(echo "$line" | cut -d '|' -f3- | sed 's/^ ìœ„ì¹˜: //')
        echo "ğŸ”— $url"
        echo "   â””â”€ ìƒíƒœ ì½”ë“œ: $status"
        if [[ -n "$location" ]]; then
            echo "   â””â”€ ìœ„ì¹˜: $location"
        else
            echo "   â””â”€ ìœ„ì¹˜ ì •ë³´ ì—†ìŒ"
        fi
        echo
    done <<< "$errors"
else
    echo "ëª¨ë“  ë§í¬ê°€ ì •ìƒì…ë‹ˆë‹¤!"
fi

# ì •ë¦¬
rm "$tmp_output" "$counter_file"
