#!/bin/bash

echo "ğŸ” Markdown ë° MDX ë§í¬ ê²€ì‚¬ ì¤‘..."

declare -A urlLocations

# ë§í¬ ì¶”ì¶œ
while IFS=: read -r file line url; do
    [[ -z "$url" ]] && continue
    if [[ -n "${urlLocations[$url]}" ]]; then
        urlLocations["$url"]+=", ${file}:${line}"
    else
        urlLocations["$url"]="${file}:${line}"
    fi
done < <(
    find . -type f \( -iname "*.md" -o -iname "*.mdx" \) -exec awk '
    {
        remainder = $0;
        while(match(remainder, /\[[^]]+\]\((https?:\/\/[^)]+)\)/, arr)) {
            print FILENAME ":" FNR ":" arr[1];
            remainder = substr(remainder, RSTART + RLENGTH);
        }
    }
    ' {} +
)

count=${#urlLocations[@]}
echo "ğŸ”— ê²€ì‚¬ ëŒ€ìƒ ë§í¬ ìˆ˜: $count"
echo

# ì„ì‹œ ê²°ê³¼ íŒŒì¼
tmp_output=$(mktemp)
> "$tmp_output"

# ë³‘ë ¬ ë§í¬ ê²€ì‚¬ í•¨ìˆ˜
check_url() {
    local url="$1"
    local location="$2"
    local status
    status=$(curl -o /dev/null -s -w "%{http_code}" "$url")

    if [[ "$status" -ge 200 && "$status" -lt 400 ]]; then
        echo "âœ… $url" >> "$tmp_output"
    elif [[ "$status" == "429" ]]; then
        echo "âš ï¸  $url | 429 Too Many Requests (ë¬´ì‹œë¨)" >> "$tmp_output"
    else
        echo "âŒ $url | $status | ìœ„ì¹˜: $location" >> "$tmp_output"
    fi
}

export -f check_url
export tmp_output

# ë³‘ë ¬ ì‹¤í–‰ (10ê°œì”©)
printf "%s\n" "${!urlLocations[@]}" | \
    xargs -n1 -P10 -I{} bash -c 'check_url "$@"' _ "{}" "${urlLocations[{}]}"

# ê²°ê³¼ ì¶œë ¥
echo
echo "ğŸ“„ ê²€ì‚¬ ê²°ê³¼:"
grep -E "^âœ…|^âš ï¸" "$tmp_output" | sort
echo

# ì˜¤ë¥˜ ë§í¬ ì •ë¦¬ ë° ì¶œë ¥
errors=$(grep "^âŒ" "$tmp_output")
if [[ -n "$errors" ]]; then
    echo "â€¼ï¸ ì˜¤ë¥˜ê°€ ë°œìƒí•œ ë§í¬ ëª©ë¡:"
    echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    while IFS= read -r line; do
        url=$(echo "$line" | cut -d '|' -f1 | sed 's/^âŒ //')
        status=$(echo "$line" | cut -d '|' -f2 | xargs)
        location=$(echo "$line" | cut -d '|' -f3- | sed 's/^ ìœ„ì¹˜: //')
        echo "ğŸ”— $url"
        echo "   â””â”€ ìƒíƒœ ì½”ë“œ: $status"
        echo "   â””â”€ ìœ„ì¹˜: $location"
        echo
    done <<< "$errors"
else
    echo "ëª¨ë“  ë§í¬ê°€ ì •ìƒì…ë‹ˆë‹¤!"
fi

# ì„ì‹œ íŒŒì¼ ì‚­ì œ
rm "$tmp_output"
